<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Map App</title>
        <style>
            html,
            body {
                margin: 0;
            }
            #map {
                height: 70vh;
                width: 70vw;
            }
            #topbar {
            }
        </style>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>

        <!-- Leaflet Awesome Markers -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"
            integrity="sha512-cUoWMYmv4H9TGP4hbm1mIjYo90WzIQFo/5jj+P5tQcDTf+iVR59RyIj/a9fRsBxzxt5Dnv/Ex7MzRIxcDwaOLw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"
            integrity="sha512-8BqQ2RH4L4sQhV41ZB24fUc1nGcjmrTA6DILV/aTPYuUzo+wBdYdp0fvQ76Sxgf36p787CXF7TktWlcxu/zyOg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
    </head>
    <body>
        <div id="app">
            <div id="topbar">
                <label for="category-select">Category</label>
                <select id="category-select">
                    <option value="all">Show all</option>
                </select>
                <button onclick="clearCategoryFilter()">clear</button>
            </div>
            <div id="map"></div>
        </div>
        <script>
            function clearCategoryFilter() {
                categoryFilter = null;
                categorySelect.value = "all";
                filterByCategory();
            }
            function filterByCategory() {
                markers.forEach((marker) => {
                    if (
                        categoryFilter === null ||
                        marker.category === categoryFilter
                    ) {
                        marker.addTo(map);
                    } else {
                        marker.remove();
                    }
                });
            }

            const categories = new Map([
                ["Stores & Shops", "red"],
                ["Flea Markets", "purple"],
                ["Events & Pop-Ups", "green"],
                ["Recycling & Collection Points", "blue"],
                ["Educational & Awareness Spaces", "pink"],
                ["Collaborative Spaces", "orange"],
                ["Local Initiatives & Collaborations", "darkgreen"],
            ]);

            const map = L.map("map").setView([48.2081, 16.3713], 13);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(map);

            const categorySelect = document.getElementById("category-select");
            for (const [name, color] of categories.entries()) {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                categorySelect.appendChild(option);
            }

            const markers = [];
            data.forEach((location) => {
                const categoryColor =
                    categories.get(location.category) ?? "gray";

                const customMarker = L.AwesomeMarkers.icon({
                    icon: "info-sign",
                    markerColor: categoryColor,
                    prefix: "glyphicon",
                });

                const marker = L.marker(
                    [location.latitude, location.longitude],
                    {
                        icon: customMarker,
                        riseOnHover: true,
                    }
                )
                    .addTo(map)
                    .bindPopup(
                        `<b>${location.name}</b><br>${location.address}<br>${location.opening_hours}<br><a href=${location.google_maps_link}>Google Maps</a>`
                    );
                marker.category = location.category;
                markers.push(marker);
            });

            let categoryFilter = null;

            categorySelect.addEventListener("change", (e) => {
                const value = e.target.value;
                if (value === "all") {
                    categoryFilter = null;
                } else {
                    categoryFilter = value;
                }
                filterByCategory();
            });
        </script>
    </body>
</html>
